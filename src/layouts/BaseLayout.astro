---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import MetaSEO from '../components/MetaSEO.astro';
import '../styles/global.css';
import '@fontsource/zalando-sans';
import { ClientRouter } from 'astro:transitions';
import { Image } from 'astro:assets';
const backgrounds = import.meta.glob('../assets/backgrounds/*.{jpeg,jpg,png,gif,webp}', { eager: true });
const sortedKeys = Object.keys(backgrounds).sort((a, b) => {
    return a.toLowerCase().localeCompare(b.toLowerCase(), undefined, { numeric: true, sensitivity: 'base' });
});
const backgroundImages = sortedKeys.map(key => (backgrounds[key] as any).default);

const { title, description } = Astro.props;
---

<html lang="vi" class="scroll-smooth">
  <head>
    <MetaSEO title={title} description={description} />
    <ClientRouter />
  </head>
  <body class="bg-[#8C8C8C] text-white relative overflow-x-hidden min-h-screen font-sans antialiased selection:bg-blue-500 selection:text-white">
    
    <!-- Noise Overlay -->
    <div class="fixed inset-0 z-50 pointer-events-none opacity-[0.05] mix-blend-overlay bg-noise"></div>

    <!-- Background Images -->
    <div id="background-container" class="fixed inset-0 -z-10 pointer-events-none overflow-hidden">
        {backgroundImages.map((img, index) => (
            <Image 
                src={img} 
                alt="Background" 
                class={`absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 ease-in-out ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
                width={1920}
                height={1080}
                data-bg-index={index}
            />
        ))}
        <div class="absolute inset-0 bg-black/20 backdrop-blur-[2px] z-10"></div>
    </div>

    <script>
        let intervalId;

        document.addEventListener('astro:page-load', () => {
            const backgrounds = document.querySelectorAll('[data-bg-index]');
            const totalBackgrounds = backgrounds.length;
            let currentIndex = 0;

            // Clear any existing interval from previous navigations
            if (intervalId) clearInterval(intervalId);

            if (totalBackgrounds > 1) {
                // Ensure we start from the first one (which matches server-side sort)
                // The HTML comes rendered with index 0 visible by default, so we just set index 0
                currentIndex = 0;
                
                // Reset all to ensure clean state (just in case)
                backgrounds.forEach((bg, index) => {
                    if (index === 0) {
                        bg.classList.remove('opacity-0');
                        bg.classList.add('opacity-100');
                    } else {
                        bg.classList.remove('opacity-100');
                        bg.classList.add('opacity-0');
                    }
                });

                intervalId = setInterval(() => {
                    const nextIndex = (currentIndex + 1) % totalBackgrounds;

                    // Fade out current
                    backgrounds[currentIndex].classList.remove('opacity-100');
                    backgrounds[currentIndex].classList.add('opacity-0');
                    
                    // Fade in next
                    backgrounds[nextIndex].classList.remove('opacity-0');
                    backgrounds[nextIndex].classList.add('opacity-100');

                    currentIndex = nextIndex;
                }, 30000); // 30s interval
            }
        });
    </script>

    <div class="w-full max-w-[1600px] mx-auto px-4">
      <Header />
      
      <main class="w-full pt-8 pb-12 relative z-10 min-h-screen">
        <slot /> 
      </main>
    </div>

    <Footer />
  </body>
</html>
