---
import { Image } from 'astro:assets';
import logoImg from '../assets/profile/logo.svg';

// Dynamic import for background to avoid missing file errors
const backgrounds = import.meta.glob('../assets/backgrounds/*.{jpeg,jpg,png,gif,webp}', { eager: true });
const backgroundImages = Object.values(backgrounds).map((img: any) => img.default);
const backgroundImg = backgroundImages[0] || backgroundImages[0]; // Use the first available image

const { images = [] } = Astro.props;
---

<div id="intro-overlay" class="fixed inset-0 z-[99999] flex items-center justify-center overflow-hidden bg-black">
  <!-- Starfield / Space Effect -->
  <div class="absolute inset-0">
    <div id="stars" class="w-full h-full opacity-50"></div>
  </div>

  <!-- Central Brand Logo -->
  <div id="intro-brand" class="absolute z-50 flex flex-col items-center justify-center transition-all duration-700 ease-out">
      <div class="relative">
          <div class="absolute inset-0 bg-blue-500/20 blur-xl rounded-full"></div>
          <Image 
              src={logoImg} 
              alt="Logo" 
              class="relative w-24 h-auto md:w-32 drop-shadow-[0_0_25px_rgba(255,255,255,0.3)]"
          />
      </div>
  </div>

  <!-- Container for floating images with 3D perspective -->
  <!-- Perspective must be on the container -->
  <div id="floating-images-container" class="absolute inset-0 overflow-hidden" 
       style="perspective: 1000px; transform-style: preserve-3d;">
       <!-- Images injected here -->
  </div>

  <!-- The final background revealing -->
  <div id="intro-background" class="absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-1000 ease-out">
      <Image 
          src={backgroundImg} 
          alt="Intro Background" 
          class="w-full h-full object-cover"
          width={1920}
          height={1080}
          loading="eager"
      />
      <!-- Matching overlay from Layout -->
      <div class="absolute inset-0 bg-black/20 backdrop-blur-[2px]"></div>
  </div>
</div>

<style>
  #stars {
    background-image: 
        radial-gradient(1px 1px at 20px 30px, #eee, rgba(0,0,0,0)),
        radial-gradient(1px 1px at 40px 70px, #fff, rgba(0,0,0,0)),
        radial-gradient(1px 1px at 50px 160px, #ddd, rgba(0,0,0,0)),
        radial-gradient(1px 1px at 90px 40px, #fff, rgba(0,0,0,0)),
        radial-gradient(1px 1px at 130px 80px, #fff, rgba(0,0,0,0)),
        radial-gradient(1px 1px at 160px 120px, #ddd, rgba(0,0,0,0));
    background-size: 200px 200px;
    animation: stars-move 100s linear infinite;
  }
  
  @keyframes stars-move {
    from { transform: translateY(0); }
    to { transform: translateY(-200px); }
  }

  .floating-image {
    position: absolute;
    top: 50%;
    left: 50%;
    /* Start centered precisely */
    transform-origin: center center;
    will-change: transform, opacity;
    border-radius: 12px;
    
    /* 3D Glassy Effect */
    box-shadow: 
        0 20px 50px rgba(0, 0, 0, 0.6),        /* Deep drop shadow */
        0 4px 10px rgba(0, 0, 0, 0.3),         /* Closer shadow */
        inset 0 1px 0 rgba(255, 255, 255, 0.4), /* Top inner highlight */
        inset 0 -1px 0 rgba(0, 0, 0, 0.3);      /* Bottom inner shadow */
        
    border: 1px solid rgba(255, 255, 255, 0.15);
    background-color: rgba(30, 30, 30, 0.8); /* Fallback */
    
    box-sizing: border-box;
    /* Backface visibility hidden so they don't look weird if they flip */
    backface-visibility: hidden;
  }
</style>

<script define:vars={{ images }}>
  document.addEventListener('astro:page-load', () => {
    // 1. Elements
    const overlay = document.getElementById('intro-overlay');
    const container = document.getElementById('floating-images-container');
    const introBg = document.getElementById('intro-background');
    const introBrand = document.getElementById('intro-brand');
    
    // UI Elements
    const header = document.querySelector('header');
    const footer = document.querySelector('footer');

    // Helper to toggle UI
    const setUIVisibility = (visible) => {
      const opacity = visible ? '1' : '0';
      const pointerEvents = visible ? 'auto' : 'none';
      
      if (header) {
        header.style.transition = 'opacity 0.5s ease-in-out';
        header.style.opacity = opacity;
        header.style.pointerEvents = pointerEvents;
      }
      if (footer) {
        footer.style.transition = 'opacity 0.5s ease-in-out';
        footer.style.opacity = opacity;
        footer.style.pointerEvents = pointerEvents;
      }
    };

    // 2. Logic to finish intro
    function finishIntro() {
      // Show UI
      setUIVisibility(true);
      
      // Dispatch event
      window.dispatchEvent(new CustomEvent('intro-complete'));
      
      // Fallback: Manually reveal content if event listeners fail
      const sidebar = document.getElementById('sidebar-wrapper');
      const content = document.getElementById('content-wrapper');
      if (sidebar) sidebar.classList.remove('opacity-0', '-translate-x-8');
      if (content) content.classList.remove('opacity-0', 'translate-x-8');
      
      if (overlay) {
        overlay.style.transition = 'opacity 1s ease-out';
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.remove(); 
        }, 1000);
      }
    }

    // 3. Check Session
    if (sessionStorage.getItem('introShown')) {
      if (overlay) overlay.style.display = 'none';
      setUIVisibility(true);
      
      // Immediate force reveal for navigation consistency
      const sidebar = document.getElementById('sidebar-wrapper');
      const content = document.getElementById('content-wrapper');
      if (sidebar) sidebar.classList.remove('opacity-0', '-translate-x-8');
      if (content) content.classList.remove('opacity-0', 'translate-x-8');

      // Still dispatch event for other listeners
      setTimeout(() => {
        window.dispatchEvent(new CustomEvent('intro-complete'));
      }, 50);
      return;
    }

    // START INTRO
    sessionStorage.setItem('introShown', 'true');
    setUIVisibility(false); // Hide UI initially
    
    // Prepare Background (Static, just hidden)
    if (introBg) {
        introBg.style.opacity = '0';
        introBg.style.transform = 'none'; // No fly-in
    }

    let validImages = images.filter(img => img && !img.includes('placeholder'));
    if (validImages.length === 0) {
        finishIntro();
        return;
    }

    // Animation Config
    const TOTAL_DURATION = 3500; 
    const IMAGE_COUNT = 150; // Increased for density
    
    // 1. Shuffle initially
    validImages.sort(() => Math.random() - 0.5);

    // 2. Expand if needed
    while (validImages.length < IMAGE_COUNT) {
        validImages = validImages.concat(validImages);
    }
    
    // 3. Trim to size
    validImages = validImages.slice(0, IMAGE_COUNT);
    
    // 4. Shuffle again
    validImages.sort(() => Math.random() - 0.5);

    for (let i = 0; i < IMAGE_COUNT; i++) {
        const imgUrl = validImages[i];
        const img = document.createElement('img');
        img.src = imgUrl;
        img.className = 'floating-image';
        
        const width = 150 + Math.random() * 200; // Slightly smaller variation for density

        img.style.width = `${width}px`;
        img.style.height = 'auto'; 
        img.style.marginLeft = `-${width/2}px`;
        img.style.marginTop = `-${width/2/(16/9)}px`; 
        
        // Vision OS floaty feel - Random slight rotation
        const rotateX = (Math.random() - 0.5) * 20;
        const rotateY = (Math.random() - 0.5) * 20;
        const rotateZ = (Math.random() - 0.5) * 10;
        
        img.style.willChange = 'transform, opacity';

        container.appendChild(img);

        const scatterX = (Math.random() - 0.5) * window.innerWidth * 2.5; 
        const scatterY = (Math.random() - 0.5) * window.innerHeight * 2.5;
        
        const startZ = -2000 - Math.random() * 3000; 
        
        const pathX = scatterX; 
        const pathY = scatterY;
        
        // Tighter Timing
        const delay = Math.random() * 1500; 
        const duration = 2000 + Math.random() * 1000; 

        // Initial state
        img.style.transform = `translate3d(${pathX}px, ${pathY}px, ${startZ}px) rotate3d(1, 1, 1, 0deg)`;
        img.style.opacity = '0';

        setTimeout(() => {
            img.style.transition = `transform ${duration}ms cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 400ms ease-in`;
            img.style.opacity = '1';
            
            const endZ = 1500; 
            // Add rotation during movement
            img.style.transform = `translate3d(${pathX}px, ${pathY}px, ${endZ}px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) rotateZ(${rotateZ}deg)`;

            setTimeout(() => {
                img.style.transition = 'opacity 200ms ease-out';
                img.style.opacity = '0';
            }, duration - 200);

        }, delay);
    }

    // REVEAL BACKGROUND (Simple Fade In)
    setTimeout(() => {
        // Fade out Brand slightly before bg
        if (introBrand) {
            introBrand.style.opacity = '0';
            introBrand.style.transform = 'scale(1.1) blur(10px)'; // Disappear effect
        }

        if (introBg) {
            introBg.style.transition = 'opacity 800ms ease-in-out';
            introBg.style.opacity = '1';
        }
    }, TOTAL_DURATION - 800); 

    // REVEAL UI
    setTimeout(finishIntro, TOTAL_DURATION);

  });
</script>
