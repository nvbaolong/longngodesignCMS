---
const { src, caption, autoplay, loop, muted, id = Math.random().toString(36).substring(7) } = Astro.props;
---

<div class="video-player-container group relative my-12 overflow-hidden rounded-2xl shadow-2xl border border-white/10 bg-black/20" id={`player-${id}`}>
  <video 
    src={src} 
    autoplay={autoplay} 
    loop={loop} 
    muted={muted} 
    playsinline
    class="w-full h-auto block cursor-pointer transition-transform duration-700 group-hover:scale-[1.01]"
  ></video>

  <!-- Overlay Play/Pause Big Button (on hover/pause) -->
  <div class="play-overlay absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/10 pointer-events-none">
      <div class="w-16 h-16 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center shadow-lg transform transition-transform group-active:scale-95">
          <svg xmlns="http://www.w3.org/2000/svg" class="play-icon w-8 h-8 text-white fill-current translate-x-0.5" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg xmlns="http://www.w3.org/2000/svg" class="pause-icon hidden w-8 h-8 text-white fill-current" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </div>
  </div>

  <!-- Liquid Glass Control Bar -->
  <div class="control-bar absolute bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md h-12 px-3 flex items-center gap-3 z-50 
              rounded-2xl border border-white/20 shadow-2xl
              bg-white/10 backdrop-blur-2xl backdrop-saturate-150
              control-hidden transition-all duration-500 ease-out">
    
    <!-- Play/Pause -->
    <button class="play-pause-btn p-2 rounded-lg hover:bg-white/10 transition-colors text-white outline-none" aria-label="Toggle Play">
      <svg xmlns="http://www.w3.org/2000/svg" class="play-small w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg xmlns="http://www.w3.org/2000/svg" class="pause-small hidden w-6 h-6 fill-current" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    </button>

    <!-- Progress Scrubber -->
    <div class="flex-1 h-1.5 relative group/progress cursor-pointer">
      <div class="progress-bg absolute inset-0 bg-white/20 rounded-full"></div>
      <div class="progress-filled absolute inset-y-0 left-0 bg-white rounded-full w-0 transition-none shadow-[0_0_15px_rgba(255,255,255,0.5)]"></div>
    </div>

    <!-- Time -->
    <span class="time-display text-[11px] font-bold text-white tabular-nums min-w-[32px]">0:00</span>

    <!-- Mute/Unmute -->
    <button class="mute-btn p-2 rounded-lg hover:bg-white/10 transition-colors text-white outline-none" aria-label="Toggle Mute">
      <svg xmlns="http://www.w3.org/2000/svg" class="volume-high w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M14 8.83v6.34L11.83 13H9v-2h2.83L14 8.83M16 4l-5 5H7v6h4l5 5V4z"/></svg>
      <svg xmlns="http://www.w3.org/2000/svg" class="volume-muted hidden w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
    </button>
  </div>
</div>

{caption && <p class="text-center text-sm text-white/40 -mt-6 mb-12 italic">{caption}</p>}

<script define:vars={{ id }}>
  (function initPlayer() {
    const container = document.getElementById(`player-${id}`);
    if (!container) return;

    const video = container.querySelector('video');
    const playBtn = container.querySelector('.play-pause-btn');
    const muteBtn = container.querySelector('.mute-btn');
    const progressContainer = container.querySelector('.progress-bg').parentElement;
    const progressFilled = container.querySelector('.progress-filled');
    const timeDisplay = container.querySelector('.time-display');
    
    // Icons
    const playSmall = container.querySelector('.play-small');
    const pauseSmall = container.querySelector('.pause-small');
    const playOverlay = container.querySelector('.play-overlay .play-icon');
    const pauseOverlay = container.querySelector('.play-overlay .pause-icon');
    const volHigh = container.querySelector('.volume-high');
    const volMuted = container.querySelector('.volume-muted');

    const updateControls = () => {
        if (video.paused) {
            playSmall.classList.remove('hidden');
            pauseSmall.classList.add('hidden');
            playOverlay.classList.remove('hidden');
            pauseOverlay.classList.add('hidden');
        } else {
            playSmall.classList.add('hidden');
            pauseSmall.classList.remove('hidden');
            playOverlay.classList.add('hidden');
            pauseOverlay.classList.remove('hidden');
        }
    };

    const togglePlay = (e) => {
        if (e) e.stopPropagation();
        if (video.paused) video.play();
        else video.pause();
    };

    playBtn.addEventListener('click', togglePlay);
    container.addEventListener('click', togglePlay);
    
    video.addEventListener('play', updateControls);
    video.addEventListener('pause', updateControls);

    // Mute Logic
    muteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        video.muted = !video.muted;
        if (video.muted) {
            volHigh.classList.add('hidden');
            volMuted.classList.remove('hidden');
        } else {
            volHigh.classList.remove('hidden');
            volMuted.classList.add('hidden');
        }
    });

    // Progress bar
    video.addEventListener('timeupdate', () => {
        if (!isNaN(video.duration)) {
            const percent = (video.currentTime / video.duration) * 100;
            progressFilled.style.width = `${percent}%`;
            
            const mins = Math.floor(video.currentTime / 60);
            const secs = Math.floor(video.currentTime % 60);
            timeDisplay.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
    });

    progressContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = progressContainer.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        video.currentTime = pos * video.duration;
    });

    // Handle initial state
    updateControls();
  })();
</script>

<style>
  .control-hidden {
    opacity: 0;
    transform: translate(-50%, 10px);
  }

  .video-player-container:hover .control-hidden {
    opacity: 1;
    transform: translate(-50%, 0);
  }

  .video-player-container::after {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    border-radius: inherit;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.15);
    z-index: 5;
  }

  .control-bar {
    box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.7);
  }

  .progress-filled::after {
      content: '';
      position: absolute;
      right: -6px;
      top: 50%;
      transform: translateY(-50%) scale(0);
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(255,255,255,1);
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .group\/progress:hover .progress-filled::after {
      transform: translateY(-50%) scale(1);
  }
</style>
